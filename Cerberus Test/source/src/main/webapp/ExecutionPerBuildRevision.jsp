<%--
  ~ Cerberus  Copyright (C) 2013  vertigo17
  ~ DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  ~
  ~ This file is part of Cerberus.
  ~
  ~ Cerberus is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU General Public License as published by
  ~ the Free Software Foundation, either version 3 of the License, or
  ~ (at your option) any later version.
  ~
  ~ Cerberus is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU General Public License for more details.
  ~
  ~ You should have received a copy of the GNU General Public License
  ~ along with Cerberus.  If not, see <http://www.gnu.org/licenses/>.
--%>
<%@page import="org.cerberus.crud.entity.BuildRevisionInvariant"%>
<%@page import="org.cerberus.crud.service.IBuildRevisionInvariantService"%>
<%@page import="org.cerberus.crud.service.IDocumentationService"%>

<%@page contentType="text/html" pageEncoding="UTF-8"%>
<!DOCTYPE HTML>
<html>
    <head>
        <meta content="text/html; charset=UTF-8" http-equiv="content-type">
        <title>Execution Per Build and Revision</title>
        <%@ include file="include/dependenciesInclusions_old.html" %>
        <style>
            .divBorder{
                background-color: #f3f6fa;
                border: solid;
                border-width: 2px;
                border-color: #8999c4;
                border-radius: 5px 5px 5px 5px;
                margin-top: 20px;
                width : 1260px;
            }

            .verticalText{
                width: 40px;
                font-size: x-small;
            }

            td{
                text-align: center;
            }
        </style>
    </head>
    <body id="body">
        <%@ include file="include/function.jsp"%>
        <%@ include file="include/header.jsp"%>
        <form action="ExecutionPerBuildRevision" name="sprintForm" id="sprintForm">
            <select name="Sprint" onchange="document.sprintForm.submit()">
                <option value="">Choose Sprint</option>
                <%
                String myLang = request.getAttribute("MyLang").toString();
                        
                IUserService myUserService = appContext.getBean(IUserService.class);
                User MyUserobj = myUserService.findUserByKeyWithDependencies(request.getUserPrincipal().getName());
                
                    String MySystem = MyUserobj.getDefaultSystem();
                IBuildRevisionInvariantService buildRevisionInvariantService = 
                        appContext.getBean(IBuildRevisionInvariantService.class);
                List<BuildRevisionInvariant> myBuildRevisionInvariant = 
                        buildRevisionInvariantService.convert(buildRevisionInvariantService.readBySystemLevel(MySystem, 1));
                for (BuildRevisionInvariant bri : myBuildRevisionInvariant){
                    %>
                <option value="<%=bri.getVersionName()%>"><%=bri.getVersionName()%></option>
                <%}%>
            </select>
        </form>
        <%
            IDocumentationService docService = appContext.getBean(IDocumentationService.class);
        %>

        <%
            String title1 = docService.findLabelHTML("page_exeperbuildrevision", "RegressionExecutionStatus", "", myLang);
            String build = docService.findLabelHTML("testcaseexecution", "Build", "Build", myLang);
            String revision = docService.findLabelHTML("testcaseexecution", "Revision", "Revision", myLang);
            String nbExecution = docService.findLabelHTML("page_exeperbuildrevision", "NbExecution", "NbExecution", myLang);
            String nbOK = docService.findLabelHTML("page_exeperbuildrevision", "NbOK", "NbOK", myLang);
            String okPercentage = docService.findLabelHTML("page_exeperbuildrevision", "OK_percentage", "%OK", myLang);
            String nbTC = docService.findLabelHTML("page_exeperbuildrevision", "NbTC", "NbTC", myLang);
            String nbExePerTc = docService.findLabelHTML("page_exeperbuildrevision", "nb_exe_per_tc", "nb_exe_per_tc", myLang);
            String days = docService.findLabelHTML("page_exeperbuildrevision", "Days", "Days", myLang);
            String nbTcPerDay = docService.findLabelHTML("page_exeperbuildrevision", "nb_tc_per_day", "nb_tc_per_day", myLang);
            String nbApp = docService.findLabelHTML("page_exeperbuildrevision", "NbAPP", "NbAPP", myLang);
        %>

        <div class="divBorder">
            <h3 style="color: blue"><%=title1%></h3>
            <table id="tableau">
                <thead>
                    <tr id="header">
                        <th style="width: 80px"><%=build%></th>
                        <th style="width: 60px"><%=revision%></th>
                        <th style="width: 60px"><%=nbExecution%></th>
                        <th style="width: 60px"><%=nbOK%></th>
                        <th style="width: 60px"><%=okPercentage%></th>
                        <th style="width: 60px"><%=nbTC%></th>
                        <th style="width: 60px"><%=nbExePerTc%></th>
                        <th style="width: 60px"><%=days%></th>
                        <th style="width: 80px"><%=nbTcPerDay%></th>
                        <th style="width: 80px"><%=nbApp%></th>
                        <th style="width: 80px">Env Detail</th>
                        <th style="width: 80px">Build Content</th>
                    </tr>
                </thead>
                <tbody>
                    <%
                        ArrayList<ArrayList<String>> arrayExecution = (ArrayList<ArrayList<String>>) request.getAttribute("arrayExecution");
                        ArrayList<ArrayList<ArrayList<String>>> arrayContent = (ArrayList<ArrayList<ArrayList<String>>>) request.getAttribute("arrayContent");
                        ArrayList<ArrayList<ArrayList<String>>> arrayExecutionEnv = (ArrayList<ArrayList<ArrayList<String>>>) request.getAttribute("arrayExecutionEnv");
                        for (ArrayList<String> arrayE : arrayExecution) {
                    %>
                    <tr>
                        <td style="font-weight: bold; background-color: white" name="Build"><%=arrayE.get(0)%></td>
                        <td style="font-weight: bold; background-color: white" name="Revision"><%=arrayE.get(1)%></td>
                        <td name="NbExecution" style="background-color: white"><%=arrayE.get(2)%></td>
                        <td name="NbOK" style="background-color: white"><%=arrayE.get(3)%></td>
                        <td name="PerOK" style="background-color: white"><%=arrayE.get(4)%></td>
                        <td name="NbTc" style="background-color: white"><%=arrayE.get(5)%></td>
                        <td name="NbExecPerTc" style="background-color: white"><%=arrayE.get(6)%></td>
                        <td name="revDuration" style="background-color: white"><%=arrayE.get(7)%></td>
                        <td name="NbExecPerTcPerDay" style="background-color: white"><%=arrayE.get(8)%></td>
                        <td name="NbApp" style="background-color: white"><%=arrayE.get(9)%></td>
                        <td>
                            <input id="button<%=arrayE.get(0)%><%=arrayE.get(1)%>EnvMore" style="display:inline" type="button"
                                   value="+" onclick="setVisibleEnv('<%=arrayE.get(0)%>', '<%=arrayE.get(1)%>');">
                            <input id="button<%=arrayE.get(0)%><%=arrayE.get(1)%>EnvLess" style="display:none" type="button" value="-"
                                   onclick="setInvisibleEnv('<%=arrayE.get(0)%>', '<%=arrayE.get(1)%>');">
                        </td>
                        <td style="background-color: white; text-align: center">
                            <%
                                ArrayList<ArrayList<String>> content = arrayContent.get(arrayExecution.indexOf(arrayE));
                                ArrayList<ArrayList<String>> environment = arrayExecutionEnv.get(arrayExecution.indexOf(arrayE));
                                if (!content.isEmpty()) {
                            %>
                            <input id="button<%=arrayE.get(0)%><%=arrayE.get(1)%>More" style="display:inline" type="button" value="+" onclick="setVisibleContent('<%=arrayE.get(0)%>', '<%=arrayE.get(1)%>');">
                            <input id="button<%=arrayE.get(0)%><%=arrayE.get(1)%>Less" style="display:none" type="button" value="-" onclick="setInvisibleContent('<%=arrayE.get(0)%>', '<%=arrayE.get(1)%>');">
                            <%
                                }
                            %>
                        </td>
                    </tr>
                    <%
                        if (!content.isEmpty()) {
                    %>
                    <tr>
                        <td id="wob" colspan="10">
                            <table id="<%=arrayE.get(0)%><%=arrayE.get(1)%>" style="display: none">
                                <%
                                    for (ArrayList<String> arrayC : content) {
                                %>
                                <tr>
                                    <td style="font-weight: bold; background-color: white; width:80px" name="Build"><%= arrayC.get(0)%></td>
                                    <td style="font-weight: bold; background-color: white; width:60px" name="Revision"><%= arrayC.get(1)%></td>
                                    <td name="Application" style="background-color: white" colspan="3"><%= arrayC.get(2)%></td>
                                    <td name="Release" style="background-color: white" colspan="3">Rls: <%= arrayC.get(3)%></td>
                                    <td><a style="text-align:right; color:black;" href="<%= arrayC.get(4)%>">Details</a></td>
                                </tr>
                                <%  }%>

                            </table>
                        </td>
                    </tr>
                    <%
                        }
                    %>
                    <tr>
                        <td id="wob" colspan="10">
                            <table id="<%=arrayE.get(0)%><%=arrayE.get(1)%>Env" style="display: none">
                                <thead>
                                    <tr>
                                        <th style="width: 60px; border-style: none;"></th>
                                        <th>Environment</th>
                                        <th style="width: 60px"><%=nbExecution%></th>
                                        <th style="width: 60px"><%=nbOK%></th>
                                        <th style="width: 60px"><%=okPercentage%></th>
                                        <th style="width: 60px"><%=nbTC%></th>
                                        <th style="width: 60px"><%=nbExePerTc%></th>
                                        <th style="width: 60px"><%=days%></th>
                                        <th style="width: 80px"><%=nbTcPerDay%></th>
                                        <th style="width: 80px"><%=nbApp%></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <%
                                        for (ArrayList<String> arrayEnv : environment) {
                                    %>
                                    <tr>
                                        <td style="border-style: none;"></td>
                                        <td><%=arrayEnv.get(0)%></td>
                                        <td name="NbExecution" style="background-color: white"><%=arrayEnv.get(1)%></td>
                                        <td name="NbOK" style="background-color: white"><%=arrayEnv.get(2)%></td>
                                        <td name="PerOK" style="background-color: white"><%=arrayEnv.get(3)%></td>
                                        <td name="NbTc" style="background-color: white"><%=arrayEnv.get(4)%></td>
                                        <td name="NbExecPerTc" style="background-color: white"><%=arrayEnv.get(5)%></td>
                                        <td name="revDuration" style="background-color: white"><%=arrayEnv.get(6)%></td>
                                        <td name="NbExecPerTcPerDay" style="background-color: white"><%=arrayEnv.get(7)%></td>
                                        <td name="NbApp" style="background-color: white"><%=arrayEnv.get(8)%></td>
                                    </tr>
                                    <%
                                        }
                                    %>
                                </tbody>
                            </table>
                        </td>
                    </tr>
                    <% }
                    %>
                </tbody>
            </table>
        </div>

        <%
            title1 = docService.findLabelHTML("page_exeperbuildrevision", "RegressionExecutionStatus1", "", myLang);

            arrayExecution = (ArrayList<ArrayList<String>>) request.getAttribute("arrayExecutionExternal");
            arrayExecutionEnv = (ArrayList<ArrayList<ArrayList<String>>>) request.getAttribute("arrayExecutionEnvExternal");
        %>
        <div class="divBorder">
            <h3 style="color: blue"><%=title1%></h3>
            <table id="tableau">
                <thead>
                    <tr id="header">
                        <th style="width: 80px"><%=build%></th>
                        <th style="width: 60px"><%=revision%></th>
                        <th style="width: 60px"><%=nbExecution%></th>
                        <th style="width: 60px"><%=nbOK%></th>
                        <th style="width: 60px"><%=okPercentage%></th>
                        <th style="width: 60px"><%=nbTC%></th>
                        <th style="width: 60px"><%=nbExePerTc%></th>
                        <th style="width: 60px"><%=days%></th>
                        <th style="width: 80px"><%=nbTcPerDay%></th>
                        <th style="width: 80px"><%=nbApp%></th>
                        <th style="width: 80px">Env Detail</th>
                    </tr>
                </thead>
                <tbody>
                    <%
                        if (!(arrayExecution == null)) {
                            for (ArrayList<String> arrayE1 : arrayExecution) {
                    %>
                    <tr>
                        <td style="font-weight: bold; background-color: white" name="Build"><%=arrayE1.get(0)%></td>
                        <td style="font-weight: bold; background-color: white" name="Revision"><%=arrayE1.get(1)%></td>
                        <td name="NbExecution" style="background-color: white"><%=arrayE1.get(2)%></td>
                        <td name="NbOK" style="background-color: white"><%=arrayE1.get(3)%></td>
                        <td name="PerOK" style="background-color: white"><%=arrayE1.get(4)%></td>
                        <td name="NbTc" style="background-color: white"><%=arrayE1.get(5)%></td>
                        <td name="NbExecPerTc" style="background-color: white"><%=arrayE1.get(6)%></td>
                        <td name="revDuration" style="background-color: white"><%=arrayE1.get(7)%></td>
                        <td name="NbExecPerTcPerDay" style="background-color: white"><%=arrayE1.get(8)%></td>
                        <td name="NbApp" style="background-color: white"><%=arrayE1.get(9)%></td>
                        <td>
                            <input id="button<%=arrayE1.get(0)%><%=arrayE1.get(1)%>EnvExtMore" style="display:inline" type="button"
                                   value="+" onclick="setVisibleEnvExternal('<%=arrayE1.get(0)%>', '<%=arrayE1.get(1)%>');">
                            <input id="button<%=arrayE1.get(0)%><%=arrayE1.get(1)%>EnvExtLess" style="display:none" type="button" value="-"
                                   onclick="setInvisibleEnvExternal('<%=arrayE1.get(0)%>', '<%=arrayE1.get(1)%>');">
                        </td>
                    </tr>
                    <tr>
                        <td id="wob" colspan="10">
                            <table id="<%=arrayE1.get(0)%><%=arrayE1.get(1)%>EnvExt" style="display: none">
                                <thead>
                                    <tr>
                                        <th style="width: 60px; border-style: none;"></th>
                                        <th>Environment</th>
                                        <th style="width: 60px"><%=nbExecution%></th>
                                        <th style="width: 60px"><%=nbOK%></th>
                                        <th style="width: 60px"><%=okPercentage%></th>
                                        <th style="width: 60px"><%=nbTC%></th>
                                        <th style="width: 60px"><%=nbExePerTc%></th>
                                        <th style="width: 60px"><%=days%></th>
                                        <th style="width: 80px"><%=nbTcPerDay%></th>
                                        <th style="width: 80px"><%=nbApp%></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <%
                                        ArrayList<ArrayList<String>> environment = arrayExecutionEnv.get(arrayExecution.indexOf(arrayE1));
                                        for (ArrayList<String> arrayEnv : environment) {
                                    %>
                                    <tr>
                                        <td style="border-style: none;"></td>
                                        <td><%=arrayEnv.get(0)%></td>
                                        <td name="NbExecution" style="background-color: white"><%=arrayEnv.get(1)%></td>
                                        <td name="NbOK" style="background-color: white"><%=arrayEnv.get(2)%></td>
                                        <td name="PerOK" style="background-color: white"><%=arrayEnv.get(3)%></td>
                                        <td name="NbTc" style="background-color: white"><%=arrayEnv.get(4)%></td>
                                        <td name="NbExecPerTc" style="background-color: white"><%=arrayEnv.get(5)%></td>
                                        <td name="revDuration" style="background-color: white"><%=arrayEnv.get(6)%></td>
                                        <td name="NbExecPerTcPerDay" style="background-color: white"><%=arrayEnv.get(7)%></td>
                                        <td name="NbApp" style="background-color: white"><%=arrayEnv.get(8)%></td>
                                    </tr>
                                    <%
                                        }
                                    %>
                                </tbody>
                            </table>
                        </td>
                    </tr>
                    <%
                        }
                    %>
                </tbody>
            </table>
        </div>
        <%
        } else {
        %>
        <div class="divBorder">
            <h3 style="color: blue"><%=title1%></h3>
        </div>
        <%
            }
        %>
        <script type="text/javascript">
            $.each( $(".verticalText"), function () {
                $(this).html($(this).text().replace(/(.)/g, "$1<br />"))
            }
        );

            function setVisibleContent(build, revision){
                setInvisibleEnv(build, revision);
                document.getElementById(build+revision).style.display = "table";
                document.getElementById('button'+build+revision+'Less').style.display = "inline";
                document.getElementById('button'+build+revision+'More').style.display = "none";
            }

            function setInvisibleContent(build, revision){
                if($("#"+build+revision).length > 0 ){
                    document.getElementById(build+revision).style.display = "none";
                    document.getElementById('button'+build+revision+'Less').style.display = "none";
                    document.getElementById('button'+build+revision+'More').style.display = "inline";
                }
            }

            function setVisibleEnv(build, revision) {
                setInvisibleContent(build, revision);
                document.getElementById(build + revision + 'Env').style.display = "table";
                document.getElementById('button' + build + revision + 'EnvLess').style.display = "inline";
                document.getElementById('button' + build + revision + 'EnvMore').style.display = "none";
            }

            function setInvisibleEnv(build, revision) {
                document.getElementById(build + revision + 'Env').style.display = "none";
                document.getElementById('button' + build + revision + 'EnvLess').style.display = "none";
                document.getElementById('button' + build + revision + 'EnvMore').style.display = "inline";
            }
            
            function setVisibleEnvExternal(build, revision) {
                document.getElementById(build + revision + 'EnvExt').style.display = "table";
                document.getElementById('button' + build + revision + 'EnvExtLess').style.display = "inline";
                document.getElementById('button' + build + revision + 'EnvExtMore').style.display = "none";
            }

            function setInvisibleEnvExternal(build, revision) {
                document.getElementById(build + revision + 'EnvExt').style.display = "none";
                document.getElementById('button' + build + revision + 'EnvExtLess').style.display = "none";
                document.getElementById('button' + build + revision + 'EnvExtMore').style.display = "inline";
            }
            
        </script>
        <br/>
        <span><%=display_footer((Date) request.getAttribute("startPageGeneration"))%></span>
    </body>
</html>